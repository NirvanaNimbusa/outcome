<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Mapping the HTTP library into the Application 1/2 - Boost.Outcome documentation</title>
<link rel="stylesheet" href="/boost-outcome/css/boost.css" type="text/css">
<meta name="generator" content="Hugo with Boostdoc theme">
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel="icon" href="/boost-outcome/images/favicon.ico" type="image/ico"/>
<body><div id="boost-common-heading-doc" style="background: #574D74 url(/boost-outcome/images/header-bg.png) repeat-x top left;">
  <div class="heading-inner" style="background: url(/boost-outcome/images/header-fg.png) no-repeat top left;">
  <div class="heading-placard"></div>

  <h1 class="heading-title">
    <a href="/">
      <img src="/boost-outcome/images/space.png" alt="Boost C++ Libraries" class="heading-logo" />
      <span class="heading-boost">Boost</span>
      <span class="heading-cpplibraries">C++ Libraries</span>
    </a>
  </h1>

  <p class="heading-quote">
    <q>...one of the most highly
    regarded and expertly designed C++ library projects in the
    world.</q> <span class="heading-attribution">&mdash; <a href=
    "http://www.gotw.ca/" class="external">Herb Sutter</a> and <a href=
    "http://en.wikipedia.org/wiki/Andrei_Alexandrescu" class="external">Andrei
    Alexandrescu</a>, <a href=
    "http://safari.awprofessional.com/?XmlId=0321113586" class="external">C++
    Coding Standards</a></span></p>
  </div>
</div>
<div id="boost-common-heading-doc-spacer"></div>
<div id="content">
    <p>Firstly we are going to need to wrap up <code>httplib::failure</code> into a custom
STL exception type before we can type erase it into an <code>exception_ptr</code>
instance. Please note that this code is defined in the <code>app</code> namespace:</p>

<div class="code-snippet"><div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">app</span>
<span class="p">{</span>
  <span class="c1">// Specialise an exception type for httplib errors
</span><span class="c1"></span>  <span class="k">struct</span> <span class="nl">httplib_error</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span>
  <span class="p">{</span>
    <span class="c1">// passthrough
</span><span class="c1"></span>    <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">;</span>
    <span class="n">httplib_error</span><span class="p">(</span><span class="n">httplib</span><span class="o">::</span><span class="n">failure</span> <span class="n">_failure</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="p">,</span> <span class="n">failure</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">_failure</span><span class="p">))</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// the original failure
</span><span class="c1"></span>    <span class="n">httplib</span><span class="o">::</span><span class="n">failure</span> <span class="n">failure</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// Type erase httplib::result&lt;U&gt; into a httplib_error exception ptr
</span><span class="c1"></span>  <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span> <span class="n">make_httplib_exception</span><span class="p">(</span><span class="k">const</span> <span class="n">httplib</span><span class="o">::</span><span class="n">result</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">(</span><span class="s">&#34;httplib failed with error &#34;</span><span class="p">);</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">status</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">success</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;success&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">bad_request</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;bad request&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">access_denied</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;access denied&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">logon_failed</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;logon failed&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">forbidden</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;forbidden&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">not_found</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;not found&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">httplib</span><span class="o">::</span><span class="n">status_code</span><span class="o">::</span><span class="nl">internal_error</span><span class="p">:</span>
      <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;internal error&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34; [url was &#34;</span><span class="p">);</span>
    <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">url</span><span class="p">);</span>
    <span class="n">str</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_exception_ptr</span><span class="p">(</span><span class="n">httplib_error</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">error</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><a href="https://github.com/ned14/boost-outcome/tree/master/doc/src/snippets/finale.cpp#L184" class="code-snippet-url" target="_blank">View this code on Github</a></div>


<p>The only real thing to note about <code>app::httplib_error</code> is that it squirrels away
the original <code>httplib::failure</code> in case that is ever needed. We do, of
course, need to create some sort of descriptive string for <code>std::runtime_error</code>
so its <code>.what()</code> returns a useful summary of the original failure. This
is the purpose of the <code>app::make_httplib_exception()</code> function.</p>


        </div></body>
</html>
